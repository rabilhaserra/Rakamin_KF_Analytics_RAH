Perbandingan Pendapatan Kimia Farma dari tahun ke tahun (2020-2023)

START
  1. AMBIL data dari tabel_analisa
  2. FILTER data hanya untuk tahun 2020 sampai 2023
  3. KELOMPOKKAN data berdasarkan TAHUN
  4. HITUNG TOTAL(nett_sales) dan TOTAL(nett_profit) untuk tiap tahun
  5. SIMPAN hasil hitungan tersebut ke dalam tabel sementara (temporary_table)

  6. DARI tabel sementara tersebut, UNTUK SETIAP BARIS:
     a. HITUNG Selisih = Total_Sales - Total_Profit
     b. AMBIL Total_Sales dari tahun sebelumnya (menggunakan LAG)
     c. HITUNG % Pertumbuhan Sales = ((Sales_Sekarang - Sales_Lalu) / Sales_Lalu) * 100
     d. AMBIL Total_Profit dari tahun sebelumnya (menggunakan LAG)
     e. HITUNG % Pertumbuhan Profit = ((Profit_Sekarang - Profit_Lalu) / Profit_Lalu) * 100

  7. TAMPILKAN semua kolom hasil perhitungan
  8. URUTKAN berdasarkan Tahun (A-Z)
END

WITH yearly_data AS (
    -- Langkah 1: Agregasi data per tahun
    SELECT
        EXTRACT(YEAR FROM date) AS year,
        SUM(nett_sales) AS total_nett_sales,
        SUM(nett_profit) AS total_nett_profit
    FROM `kimia_farma.tabel_analisa`
    WHERE EXTRACT(YEAR FROM date) BETWEEN 2020 AND 2023
    GROUP BY 1
)
SELECT
    year,
    total_nett_sales,
    total_nett_profit,
    -- 1. Selisih antara Sales dan Profit (Biaya/Operasional)
    (total_nett_sales - total_nett_profit) AS gap_sales_profit,
    
    -- 2. Growth Percentage Nett Sales
    ROUND(((total_nett_sales - LAG(total_nett_sales) OVER (ORDER BY year)) / 
    NULLIF(LAG(total_nett_sales) OVER (ORDER BY year), 0)) * 100, 2) AS sales_growth_pct,
    
    -- 3. Growth Percentage Nett Profit
    ROUND(((total_nett_profit - LAG(total_nett_profit) OVER (ORDER BY year)) / 
    NULLIF(LAG(total_nett_profit) OVER (ORDER BY year), 0)) * 100, 2) AS profit_growth_pct
FROM yearly_data
ORDER BY year;

Penjelasan Kolom Baru:
gap_sales_profit: Menunjukkan seberapa besar biaya operasional, HPP, dan diskon gabungan (selisih antara omzet kotor dan profit bersih).

sales_growth_pct: Persentase kenaikan/penurunan pendapatan dibanding tahun lalu.

profit_growth_pct: Persentase kenaikan/penurunan keuntungan dibanding tahun lalu.
