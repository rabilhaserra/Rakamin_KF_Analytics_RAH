#Di sini kita mencari transaksi "mustahil" seperti harga nol, diskon tidak masuk akal, atau tanggal di masa depan.

SELECT 
  'Transaksi Anomali' AS kategori,
  COUNTIF(price <= 0) AS harga_nol_atau_minus,
  COUNTIF(discount_percentage > 1.0) AS diskon_diatas_100_persen,
  COUNTIF(rating < 1 OR rating > 5) AS rating_diluar_skala,
  COUNTIF(date > CURRENT_DATE()) AS tanggal_masa_depan
FROM `kimia_farma.kf_final_transaction`;

#Kita mengecek apakah ada produk yang terdaftar namun tidak memiliki harga atau harganya terlalu rendah/tinggi yang mencurigakan.

SELECT 
  product_id,
  product_name,
  price
FROM `kimia_farma.kf_product`
WHERE price <= 0 
   OR price > 10000000; -- Asumsi jika ada obat di atas 10jt perlu dicek manual

#Anomali tersering pada stok adalah nilai negatif (stok bocor/salah input).

SELECT 
  inventory_id,
  branch_id,
  product_id,
  opname_stock
FROM `kimia_farma.kf_inventory`
WHERE opname_stock < 0; -- Stok tidak boleh minus

#Pada tabel cabang, kita pastikan rating rata-rata cabang masih dalam standar perusahaan (skala 1-5).

SELECT 
  branch_id,
  branch_name,
  rating
FROM `kimia_farma.kf_kantor_cabang`
WHERE rating < 1 OR rating > 5;

#Cek apakah ada branch_id ada yang tidak sesuai dengan branch_name, kota, dan provinsinya
START
  1. BUKA tabel kf_kantor_cabang.
  2. KELOMPOKKAN data berdasarkan branch_id.
  3. HITUNG jumlah variasi unik untuk:
     - Nama Cabang (branch_name)
     - Kota
     - Provinsi
  4. GABUNGKAN semua variasi yang ditemukan ke dalam teks (STRING_AGG) agar mudah dibaca.
  5. FILTER hasil:
     - Tampilkan hanya jika ada ID yang punya lebih dari 1 Nama, ATAU lebih dari 1 Kota, ATAU lebih dari 1 Provinsi.
  6. TAMPILKAN baris yang bermasalah tersebut.
END
SELECT 
    branch_id, 
    COUNT(DISTINCT branch_name) AS jml_nama,
    COUNT(DISTINCT kota) AS jml_kota,
    COUNT(DISTINCT provinsi) AS jml_provinsi,
    STRING_AGG(DISTINCT branch_name, ' | ') AS daftar_nama,
    STRING_AGG(DISTINCT kota, ' | ') AS daftar_kota,
    STRING_AGG(DISTINCT provinsi, ' | ') AS daftar_provinsi
FROM `kimia_farma.kf_kantor_cabang`
GROUP BY 1
HAVING jml_nama > 1 OR jml_kota > 1 OR jml_provinsi > 1;
